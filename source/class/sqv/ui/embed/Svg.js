/* ************************************************************************

   SQville Software: http://sqville.com

   Copyright:
     None

   License:
     MIT 

   Authors:
     * Chris Eskew (sqville)

************************************************************************ */
/* ************************************************************************


************************************************************************* */
/**
 * Name: sqv.ui.embed.Svg
 * Description: SVG templates and functions for embedding and generating SVG assets
 * Feature #1: Adds a URL encoded data URI, SVG "data:image/svg+xml" to qx.ui.basic.Image source property
 * Feature #2: Creates a raw SVG tag as a string to be added anywhere
 * Design: 
 * 		- This class stores SVG tag templates in its static SVG map - this is what makes this "embedded"
 * 		- This class has functions that populates SVG templates with provided map values which produces a string of raw or data encoded SVG
 * 		- Resulting SVGs are stored/cached in an internal store called "__data". 
 * Notes: 
 * 
 * @require(sqv.ui.basic.MImage)
 * 
 */
qx.Class.define("sqv.ui.embed.Svg",
{

  extend : qx.core.Object,
  
  construct : function()
  {
  	qx.Class.include(qx.ui.basic.Image, sqv.ui.basic.MImage);
  },
  
  statics :
  {
    
    __datauri : "data:image/svg+xml,",
       
    //__svgtag : '<svg id="{{id}}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="{{width}}" height="{{height}}" viewBox="0 0 {{viewbox_width}} {{viewbox_height}}" class="{{class}}">',
    __svgtag : '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 {{viewbox_width}} {{viewbox_height}}">',
    __fasvgtemplate : '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 {{vbw}} {{vbh}}"><path d="{{pathd}}"></path></svg>',
    
    /**
     * Holds a map containig svg xml
     * 
     */
    
    SVG :
    {
      // SVG tag content in the raw
      "sqlogo" : '<g><ellipse cy="64" cx="64" stroke-width="2.34090127096591" ry="62.829549364517" rx="62.829549364517" stroke="{{ellipsestroke}}" fill="transparent" /><path id="path1" fill="{{path1fill}}" d="M28.734375,36.4918746948242L32.63671875,36.8199996948242 36.46875,37.8043746948242 36.46875,56.0387496948242 34.640625,55.5114059448242 33.28125,55.3356246948242 31.2773418426514,55.7340621948242 29.578125,56.9293746948242 28.4179668426514,58.6871871948242 28.03125,60.7731246948242 28.4531230926514,62.9528121948242 29.71875,65.6481246948242 31.171875,68.1793746948242 32.89453125,71.5719528198242 34.125,74.9059371948242 34.86328125,78.1813278198242 35.109375,81.3981246948242 34.69482421875,85.8834762573242 33.451171875,90.0114059448242 31.37841796875,93.7819137573242 28.4765625,97.1949996948242 24.97705078125,100.025077819824 21.111328125,102.046562194824 16.87939453125,103.259452819824 12.28125,103.663749694824 7.7109375,103.136405944824 3.18750023841858,101.554374694824 3.18750023841858,83.0387496948242 5.75390625,84.3395309448242 8.015625,84.7731246948242 10.294921875,84.4157028198242 12.1640625,83.3434371948242 13.4121084213257,81.7321090698242 13.828125,79.7574996948242 13.6611318588257,78.8463668823242 13.1601552963257,77.5192184448242 12.3251943588257,75.7760543823242 11.15625,73.6168746948242 9.2900390625,69.8668746948242 7.95703125,66.1168746948242 7.1572265625,62.3668746948242 6.890625,58.6168746948242 7.29345703125,54.2501792907715 8.501953125,50.1969566345215 10.51611328125,46.4572105407715 13.3359375,43.0309371948242 16.71533203125,40.1700973510742 20.408203125,38.1266403198242 24.41455078125,36.9005661010742 28.734375,36.4918746948242z M75.8439636230469,55.3356246948242L73.0812683105469,55.6080856323242 70.5119323730469,56.4254684448242 68.1359558105469,57.7877731323242 65.9533386230469,59.6949996948242 64.1281433105469,61.9742965698242 62.8244285583496,64.4528121948242 62.0422019958496,67.1305465698242 61.7814598083496,70.0074996948242 62.1330223083496,73.6198043823242 63.1877098083496,76.8629684448242 64.9455261230469,79.7369918823242 67.4064636230469,82.2418746948242 67.4064636230469,75.0699996948242 84.2345886230469,75.0699996948242 84.2345886230469,82.2418746948242 86.6955184936523,79.6666793823242 88.4533309936523,76.7692184448242 89.5080184936523,73.5494918823242 89.8595886230469,70.0074996948242 89.5988388061523,67.1305465698242 88.8166122436523,64.4528121948242 87.5129013061523,61.9742965698242 85.6877136230469,59.6949996948242 83.5080261230469,57.7877731323242 81.1408386230469,56.4254684448242 78.5861511230469,55.6080856323242 75.8439636230469,55.3356246948242z M75.8439636230469,36.4918746948242L83.4054794311523,37.2096481323242 90.1994247436523,39.3629684448242 96.2257919311523,42.9518356323242 101.484588623047,47.9762496948242 104.929901123047,52.7955856323242 107.390838623047,57.9723434448242 108.867401123047,63.5065231323242 109.359588623047,69.3981246948242 108.923065185547,75.1959762573242 107.613494873047,80.6832809448242 105.430877685547,85.8600387573242 102.375213623047,90.7262496948242 98.9240341186523,94.6549606323242 94.8517684936523,97.9098434448242 90.1584091186523,100.490898132324 84.8439636230469,102.398124694824 84.8439636230469,107.976249694824 66.7502136230469,107.976249694824 66.7502136230469,102.398124694824 61.4518699645996,100.490898132324 56.7131004333496,97.8629684448242 52.5339012145996,94.5143356323242 48.9142723083496,90.4449996948242 45.9919090270996,85.8395309448242 43.9045066833496,80.8824996948242 42.6520652770996,75.5739059448242 42.2345848083496,69.9137496948242 42.9611473083496,62.5514450073242 45.1408348083496,55.8864059448242 48.7736473083496,49.9186325073242 53.8595848083496,44.6481246948242 58.8547019958496,41.0797653198242 64.1838073730469,38.5309371948242 69.8468933105469,37.0016403198242 75.8439636230469,36.4918746948242z" /></g>',
      "treefolderclosed" : '<path d="M0 0h24v24H0z" fill="{{path1fill}}"/><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>',
      "date" : '<g><path id="path1" transform="rotate(0,9,9) translate(4,4.43749988079071) scale(0.3125,0.3125)  " fill="#000000" d="M24.100006,22.899997L24.199982,22.899997 28,22.899997 28,25.899997 24.100006,25.899997z M16.699982,22.899997L22.799988,22.899997 22.799988,25.899997 16.699982,25.899997z M9.7999878,22.899997L15.399994,22.899997 15.399994,25.899997 9.7999878,25.899997z M3.6000061,22.899997L8.5,22.899997 8.5,25.899997 3.6000061,25.899997z M24.100006,16.699999L24.199982,16.699999 28,16.699999 28,21.599994 24.100006,21.599994z M16.699982,16.699999L22.799988,16.699999 22.799988,21.599994 16.699982,21.599994z M3.6000061,16.699999L8.5,16.699999 8.5,21.599994 3.6000061,21.599994z M24.100006,12.099993L24.199982,12.099993 28,12.099993 28,15.399996 24.100006,15.399996z M16.699982,12.099993L22.799988,12.099993 22.799988,15.399996 16.699982,15.399996z M9.7999878,12.099993L15.399994,12.099993 15.399994,15.399996 9.7999878,15.399996z M3.6000061,12.099993L8.5,12.099993 8.5,15.399996 3.6000061,15.399996z M2.2999878,10.799989L2.2999878,27.200001 29.299988,27.200001 29.299988,10.799989z M0,4.0999916L6.1999817,4.0999916 6.1999817,6.299989C6.1999817,7.8999951 7.5,9.2999895 9.1999817,9.2999895 10.799988,9.2999895 12.199982,8.0000007 12.199982,6.299989L12.199982,4.0999916 20.600006,4.0999916 20.600006,6.299989C20.600006,7.8999951 21.899994,9.2999895 23.600006,9.2999895 25.199982,9.2999895 26.600006,8.0000007 26.600006,6.299989L26.600006,4.0999916 32,4.0999916 32,29.200001 0,29.200001z M23.5,0C24.199982,2.3754274E-07,24.799988,0.59999114,24.799988,1.2999883L24.799988,6.299989C24.799988,7.0000012 24.199982,7.599992 23.5,7.599992 22.799988,7.599992 22.199982,7.0000012 22.199982,6.299989L22.199982,1.2999883C22.199982,0.59999114,22.799988,2.3754274E-07,23.5,0z M9.1999817,0C9.8999939,2.3754274E-07,10.5,0.59999114,10.5,1.2999883L10.5,6.299989C10.5,7.0000012 9.8999939,7.599992 9.1999817,7.599992 8.5,7.599992 7.8999939,7.0000012 7.8999939,6.299989L7.8999939,1.2999883C7.7999878,0.59999114,8.3999939,2.3754274E-07,9.1999817,0z" /></g>',
      "calendar-alt" : '<path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/>'
    },
    
    FASVG :
    {
      "calendar-alt" : {vbw : "448", vbh : "512", pathd : "M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"},
      "calendar-alt-1" : {vbw : "448", vbh : "512", pathd : "M 352 276 L 352 236 C 352 229.4 346.6 224 340 224 L 300 224 C 293.4 224 288 229.4 288 236 L 288 276 C 288 282.6 293.4 288 300 288 L 340 288 C 346.6 288 352 282.6 352 276 Z  M 448 112 L 448 464 C 448 490.5 426.5 512 400 512 L 48 512 C 21.5 512 0 490.5 0 464 L 0 112 C 0 85.5 21.5 64 48 64 L 96 64 L 96 12 C 96 5.4 101.4 0 108 0 L 148 0 C 154.6 0 160 5.4 160 12 L 160 64 L 288 64 L 288 12 C 288 5.4 293.4 0 300 0 L 340 0 C 346.6 0 352 5.4 352 12 L 352 64 L 400 64 C 426.5 64 448 85.5 448 112 Z  M 400 458 L 400 160 L 48 160 L 48 458 C 48 461.3 50.7 464 54 464 L 394 464 C 397.3 464 400 461.3 400 458 Z"},
      "bath" : {vbw : "512", vbh : "512", pathd : "M488 256H80V112c0-17.645 14.355-32 32-32 11.351 0 21.332 5.945 27.015 14.88-16.492 25.207-14.687 59.576 6.838 83.035-4.176 4.713-4.021 11.916.491 16.428l11.314 11.314c4.686 4.686 12.284 4.686 16.971 0l95.03-95.029c4.686-4.686 4.686-12.284 0-16.971l-11.314-11.314c-4.512-4.512-11.715-4.666-16.428-.491-17.949-16.469-42.294-21.429-64.178-15.365C163.281 45.667 139.212 32 112 32c-44.112 0-80 35.888-80 80v144h-8c-13.255 0-24 10.745-24 24v16c0 13.255 10.745 24 24 24h8v32c0 28.43 12.362 53.969 32 71.547V456c0 13.255 10.745 24 24 24h16c13.255 0 24-10.745 24-24v-8h256v8c0 13.255 10.745 24 24 24h16c13.255 0 24-10.745 24-24v-32.453c19.638-17.578 32-43.117 32-71.547v-32h8c13.255 0 24-10.745 24-24v-16c0-13.255-10.745-24-24-24z"} 
    },
    
    /** @type {Map} Internal data structure to cache strings of svgs */
    __data : {},
    
    
    mapfasvg : function(fontname)
	{
		// merge svg tag
		return qx.bom.Template.render(this.__fasvgtemplate, this.FASVG[fontname]);
	},
    
    /** API - populates svg url using map interface
     * map (Map) - required
     * encode (Boolean) - optional; defult = true; false value produces raw SVG markup
     */ 
    mapsvg : function(map, encode)
    {
	  	var svg = "";
	  	var lencode = true;
	  	var svgid = this.__maptosvgid(map);
	  	svg = this.__getfrombank(svgid);
	  	
	  	if (map && svg == "") {
	      	if (encode === undefined){
	      		lencode = true;
	      	}
	      	else {
	      		if (!encode)
	      			lencode = false;
	      	}
	      		
	      		
		    if (lencode) {
		    	svg = this.__datauri + encodeURIComponent(this.__mapraw(map));
		    	// Bank encoded svg only; Raw svg is never saved ju
		    	this.__banksvg(svgid, svg);
		    }
		    else {
		    	svg = this.__mapraw(map);
		    }	  	
		}
	  	
	  	return svg;
    },
    
    __banksvg : function(map, svg)
    {
       // Shorthand
	   var entry = this.__data[map];
	
	   if (!entry) {
	        entry = this.__data[map] = {};
	        entry.svg = svg;
	   }
    },
    
    __getfrombank : function(source)
    {
    	var entry = this.__data[source];
    	return entry ? entry.svg : "";
    },
    
    __maptosvgid : function(map)
    {
    	var strsvgid = "";
    	//loop through key values and build a string id
    	for (var key in map)
        {
          var value = map[key];
          strsvgid += key+value;
        }
        return strsvgid;
    },
     
	
	/**
     * 
 	 * The object must contain at least id, height, width, vb-height, vb-width 
     */
	__mapraw : function(map)
	{
		// merge svg tag
		var svgopentag = ""; 
		var svgcontent = "";
		var svgendtag = "</svg>";
		svgopentag = this.__rendersvgopentag(map);
		svgcontent = this.__rendersvgcontenttag(map);
		
		var mergedsource = svgopentag + svgcontent + svgendtag;
		return mergedsource;
	},
	
	__rendersvgopentag : function(map)
	{
		// merge svg tag
		return qx.bom.Template.render(this.__svgtag, map);
	},
	
	__rendersvgcontenttag : function(map)
	{
		// merge svg tag
		return qx.bom.Template.render(this.SVG[map.id], map);
	}
  }
});
